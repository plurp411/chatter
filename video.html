<!DOCTYPE html>
<html class="h-100 w-100 overflow-hidden">
<head>

  <title>Chatter</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="jquery-3.5.1.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

</head>

  <body class="bg-dark w-100 h-100 overflow-hidden">
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->

    <div id="loading-div" class="row align-items-center h-100 w-100">
      <div class="col-12 text-center">
        <div class="spinner-border text-secondary"></div>
      </div>
    </div>

    <div class="d-none" id="all-div">
      <div class="w-100 p-2 text-center mt-3">
        <div class="border border-white rounded" id="player"></div>
      </div>

      <div class="w-100 p-2 text-center">

        <div class="w-100 text-center">
          <input type="text" class="form-control d-inline-block" id="link-input" placeholder="Video Url" style="max-width: 600px;"/>
        </div>
        <div class="w-100 text-center">
          <button class="btn btn-secondary mt-2 w-100 d-inline-block" id="submit-link-button" style="max-width: 600px;">Submit</button>
        </div>

      </div>
    </div>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-analytics.js"></script>

  <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-database.js"></script>

  <script>

    var FB_CONFIG = {
      apiKey: "AIzaSyCXe08GXfiLcvWO2aYckY7s-eTMxkp3j-8",
      authDomain: "test-page-3520d.firebaseapp.com",
      databaseURL: "https://test-page-3520d.firebaseio.com",
      projectId: "test-page-3520d",
      storageBucket: "test-page-3520d.appspot.com",
      messagingSenderId: "460082871451",
      appId: "1:460082871451:web:9493492586b77c63ae9a3e",
      measurementId: "G-M0HZGGGG13"
    };

    let database = firebase.initializeApp(FB_CONFIG).database();

    const CURRENT_USER = '_' + Math.random().toString(36).substr(2, 9);
    let SHOULD_IGNORE = false;
    let VIDEO_ID = '';
    let GOT_VIDEO_ID;
    let GOT_CURRENT_TIME;
    let GOT_IS_PAUSED;

  </script>



    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player = null;
      function onYouTubeIframeAPIReady() {

        readVideoInfo();

        

      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        // event.target.playVideo();
        // readVideoInfo();

        
        $("#loading-div").remove();

        $("#all-div").removeClass("d-none");
        $("#all-div").addClass("d-block");
      }

      var arraysMatch = function(arr1, arr2) {

        // Check if the arrays are the same length
        if (arr1.length !== arr2.length) return false;

        // Check if all items exist and are in the same order
        for (var i = 0; i < arr1.length; i++) {
          if (arr1[i] !== arr2[i]) return false;
        }

        // Otherwise, return true
        return true;

      };

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      // var done = false;
      function onPlayerStateChange(event) {



        console.log(event.data);



        // console.log('------------');
        // console.log(event.data);
        // console.log(getVideoTime());

        // player.playVideoAt(index:Number);

    SHOULD_IGNORE = false;
    if (!SHOULD_IGNORE) {

          let isPaused = true;
          if (event.data == YT.PlayerState.PLAYING) {
            isPaused = false;
          }

          const currentTime = getVideoTime();
          if (VIDEO_ID != GOT_VIDEO_ID || isPaused != GOT_IS_PAUSED || (Math.abs(currentTime - GOT_CURRENT_TIME) > 1)) {
            if (event.data != YT.PlayerState.BUFFERING) {
              writeVideoInfo(CURRENT_USER, VIDEO_ID, currentTime, isPaused);
            }
          }

    } else {
      SHOULD_IGNORE = false;
    }

        // if (event.data == YT.PlayerState.PLAYING && !done) {
        //   setTimeout(stopVideo, 6000);
        //   done = true;
        // }
      }

      function stopVideo() {
        player.stopVideo();
      }

      function getVideoTime() {
        return player.getCurrentTime();
      }

      function writeVideoInfo(fromUser, videoId, currentTime, isPaused) {

        database.ref('video/').update({

          from_user: fromUser,
          video_id: videoId,
          current_time: currentTime,
          is_paused: isPaused

        }).then(function() {

          // sent

        });
      }

    function readVideoInfo() {
     var infoRef = database.ref('video/');
     infoRef.off();
     infoRef.on('value', function(snapshot) {

        const fromUser = snapshot.val().from_user;
        const videoId = snapshot.val().video_id;
        const currentTime = snapshot.val().current_time;
        const isPaused = snapshot.val().is_paused;

        if (fromUser != CURRENT_USER) {
          // player.playVideoAt(currentTime);

          // SHOULD_IGNORE = true;

          // player.seekTo(currentTime);

          // if (isPaused) {
          //   player.pauseVideo();
          // } else {
          //   player.playVideo();
          // }

          // console.log(currentTime);
          // console.log(isPaused);

          GOT_VIDEO_ID = videoId;
          GOT_CURRENT_TIME = currentTime;
          GOT_IS_PAUSED = isPaused;

        if (videoId != VIDEO_ID) {

      VIDEO_ID = videoId;

      if (player == null) {

          player = new YT.Player('player', {
          height: '337.5',
          width: '600',
          videoId: videoId,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
          });

      } else {
        player.loadVideoById(videoId);
      }

        } else {

          SHOULD_IGNORE = true;

          player.seekTo(currentTime);

          if (isPaused) {
            player.pauseVideo();
          } else {
            player.playVideo();
          }

          // console.log(currentTime);
          // console.log(isPaused);
        }



        }

      });
    }

    $("#submit-link-button").click(function() {

    const videoLink = $("#link-input").val();

    var videoId = videoLink.split('v=')[1];
    var ampersandPosition = videoId.indexOf('&');
    if(ampersandPosition != -1) {
      videoId = videoId.substring(0, ampersandPosition);
    }

    // if (videoId != VIDEO_ID) {

      VIDEO_ID = videoId;

      if (player == null) {

          player = new YT.Player('player', {
            height: '337.5',
            width: '600',
            videoId: videoId,
            events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
            }
          });

      } else {
        player.loadVideoById(videoId);
      }

        player.pauseVideo();
        writeVideoInfo(CURRENT_USER, VIDEO_ID, 0, true);
      // }

    });

    </script>





  </body>
</html>


<!-- <!DOCTYPE html>
<html lang="en">
<html>
<head>

  <title>Video Player</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="jquery-3.5.1.js"></script>

</head>






<body>
  
  <div>
   

<div id="videoContainer">
  <iframe width="941" height="539" src="https://www.youtube.com/embed/RBSGKlAvoiM" frameborder="0" allowfullscreen></iframe>
</div>


<p><a class="introVid" href="#video">Watch the video</a></p>



  </div>


<script>
// <iframe width="941" height="539" src="https://www.youtube.com/embed/RBSGKlAvoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

function autoPlayVideo(vcode, width, height){
  // "use strict";
  // $("#videoContainer").html('<iframe width="'+width+'" height="'+height+'" src="https://www.youtube.com/embed/'+vcode'" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>');

  document.getElementById('videoContainer').getCurrentTime();
}

$('a.introVid').click(function(){
  autoPlayVideo('RBSGKlAvoiM','450','283');
});


</script>

</body>
</html>


 -->

